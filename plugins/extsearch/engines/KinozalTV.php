<?php

class KinozalTVEngine extends commonEngine
{
       	public $defaults = array( "public"=>false, "page_size"=>40, "cookies"=>"kinozal.guru|uid=XXX;pass=XXX;" );
       	
	public $categories = array( 'all'=>'0', 
		'ÐšÐ¸Ð½Ð¾ - Ð¡ÐµÑ€Ð¸Ð°Ð»'=>'5',
		'ÐšÐ¸Ð½Ð¾ - ÐšÐ¾Ð¼ÐµÐ´Ð¸Ñ'=>'8',
		'ÐšÐ¸Ð½Ð¾ - Ð‘Ð¾ÐµÐ²Ð¸Ðº / Ð’Ð¾ÐµÐ½Ð½Ñ‹Ð¹'=>'6',
		'ÐšÐ¸Ð½Ð¾ - Ð¢Ñ€Ð¸Ð»Ð»ÐµÑ€ / Ð”ÐµÑ‚ÐµÐºÑ‚Ð¸Ð²'=>'15',
		'ÐšÐ¸Ð½Ð¾ - Ð”Ñ€Ð°Ð¼Ð°'=>'17',
		'ÐšÐ¸Ð½Ð¾ - ÐœÐµÐ»Ð¾Ð´Ñ€Ð°Ð¼Ð°'=>'35',
		'ÐšÐ¸Ð½Ð¾ - Ð˜Ð½Ð´Ð¸Ð¹ÑÐºÐ¾Ðµ'=>'39',
		'ÐšÐ¸Ð½Ð¾ - Ð¤Ð°Ð½Ñ‚Ð°ÑÑ‚Ð¸ÐºÐ°'=>'13',
		'ÐšÐ¸Ð½Ð¾ - Ð¤ÑÐ½Ñ‚ÐµÐ·Ð¸'=>'14',
		'ÐšÐ¸Ð½Ð¾ - Ð£Ð¶Ð°Ñ / ÐœÐ¸ÑÑ‚Ð¸ÐºÐ°'=>'24',
		'ÐšÐ¸Ð½Ð¾ - ÐŸÑ€Ð¸ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ'=>'11',
		'ÐšÐ¸Ð½Ð¾ - ÐÐ°ÑˆÐµ ÐšÐ¸Ð½Ð¾'=>'10',
		'ÐšÐ¸Ð½Ð¾ - Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹'=>'9',
		'ÐšÐ¸Ð½Ð¾ - Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ð»ÑŒÐ½Ñ‹Ð¹'=>'18',
		'ÐšÐ¸Ð½Ð¾ - Ð¡Ð¿Ð¾Ñ€Ñ‚'=>'37',
		'ÐšÐ¸Ð½Ð¾ - Ð¡ÐµÐ¼ÐµÐ¹Ð½Ñ‹Ð¹'=>'12',
		'ÐšÐ¸Ð½Ð¾ - Ð”ÐµÑ‚ÑÐºÐ¸Ð¹'=>'19',
		'ÐšÐ¸Ð½Ð¾ - ÐšÐ»Ð°ÑÑÐ¸ÐºÐ°'=>'7',
		'ÐšÐ¸Ð½Ð¾ - ÐšÐ¾Ð½Ñ†ÐµÑ€Ñ‚ / Ð¢Ð’-ÑˆÐ¾Ñƒ'=>'36',
		'ÐšÐ¸Ð½Ð¾ - Ð¢ÐµÐ°Ñ‚Ñ€, ÐžÐ¿ÐµÑ€Ð°, Ð‘Ð°Ð»ÐµÑ‚'=>'38',
		'ÐšÐ¸Ð½Ð¾ - Ð­Ñ€Ð¾Ñ‚Ð¸ÐºÐ°'=>'16',
		'ÐœÑƒÐ»ÑŒÑ‚ - Ð‘ÑƒÑ€Ð¶ÑƒÐ¹ÑÐºÐ¸Ð¹'=>'21',
		'ÐœÑƒÐ»ÑŒÑ‚ - Ð ÑƒÑÑÐºÐ¸Ð¹'=>'22',
		'ÐœÑƒÐ»ÑŒÑ‚ - ÐÐ½Ð¸Ð¼Ðµ'=>'20',
		'ÐœÑƒÐ·Ñ‹ÐºÐ° - Ð‘ÑƒÑ€Ð¶ÑƒÐ¹ÑÐºÐ°Ñ'=>'3',
		'ÐœÑƒÐ·Ñ‹ÐºÐ° - Ð ÑƒÑÑÐºÐ°Ñ'=>'4',
		'ÐœÑƒÐ·Ñ‹ÐºÐ° - ÐšÐ»Ð°ÑÑÐ¸Ñ‡ÐµÑÐºÐ°Ñ'=>'42',
		'Ð”Ñ€ÑƒÐ³Ð¾Ðµ - ÐÑƒÐ´Ð¸Ð¾ÐšÐ½Ð¸Ð³Ð¸'=>'2',
		'Ð”Ñ€ÑƒÐ³Ð¾Ðµ - Ð’Ð¸Ð´ÐµÐ¾ÐºÐ»Ð¸Ð¿Ñ‹'=>'1',
		'Ð”Ñ€ÑƒÐ³Ð¾Ðµ - Ð˜Ð³Ñ€Ñ‹'=>'23',
		'Ð”Ñ€ÑƒÐ³Ð¾Ðµ - ÐŸÑ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ñ‹'=>'32',
		'Ð”Ñ€ÑƒÐ³Ð¾Ðµ - Ð“Ñ€Ð°Ñ„Ð¸ÐºÐ°'=>'40',
		'Ð”Ñ€ÑƒÐ³Ð¾Ðµ - Ð‘Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ°'=>'41' );

	protected static function getInnerCategory($cat)
	{
		$categories = array(
			'5'=>'ÐšÐ¸Ð½Ð¾ - Ð¡ÐµÑ€Ð¸Ð°Ð»',
			'8'=>'ÐšÐ¸Ð½Ð¾ - ÐšÐ¾Ð¼ÐµÐ´Ð¸Ñ',
			'6'=>'ÐšÐ¸Ð½Ð¾ - Ð‘Ð¾ÐµÐ²Ð¸Ðº / Ð’Ð¾ÐµÐ½Ð½Ñ‹Ð¹',
			'15'=>'ÐšÐ¸Ð½Ð¾ - Ð¢Ñ€Ð¸Ð»Ð»ÐµÑ€ / Ð”ÐµÑ‚ÐµÐºÑ‚Ð¸Ð²',
			'17'=>'ÐšÐ¸Ð½Ð¾ - Ð”Ñ€Ð°Ð¼Ð°',
			'35'=>'ÐšÐ¸Ð½Ð¾ - ÐœÐµÐ»Ð¾Ð´Ñ€Ð°Ð¼Ð°',
			'39'=>'ÐšÐ¸Ð½Ð¾ - Ð˜Ð½Ð´Ð¸Ð¹ÑÐºÐ¾Ðµ',
			'13'=>'ÐšÐ¸Ð½Ð¾ - Ð¤Ð°Ð½Ñ‚Ð°ÑÑ‚Ð¸ÐºÐ°',
			'14'=>'ÐšÐ¸Ð½Ð¾ - Ð¤ÑÐ½Ñ‚ÐµÐ·Ð¸',
			'24'=>'ÐšÐ¸Ð½Ð¾ - Ð£Ð¶Ð°Ñ / ÐœÐ¸ÑÑ‚Ð¸ÐºÐ°',
			'11'=>'ÐšÐ¸Ð½Ð¾ - ÐŸÑ€Ð¸ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ',
			'10'=>'ÐšÐ¸Ð½Ð¾ - ÐÐ°ÑˆÐµ ÐšÐ¸Ð½Ð¾',
			'9'=>'ÐšÐ¸Ð½Ð¾ - Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹',
			'18'=>'ÐšÐ¸Ð½Ð¾ - Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð°Ð»ÑŒÐ½Ñ‹Ð¹',
			'37'=>'ÐšÐ¸Ð½Ð¾ - Ð¡Ð¿Ð¾Ñ€Ñ‚',
			'12'=>'ÐšÐ¸Ð½Ð¾ - Ð¡ÐµÐ¼ÐµÐ¹Ð½Ñ‹Ð¹',
			'19'=>'ÐšÐ¸Ð½Ð¾ - Ð”ÐµÑ‚ÑÐºÐ¸Ð¹',
			'7'=>'ÐšÐ¸Ð½Ð¾ - ÐšÐ»Ð°ÑÑÐ¸ÐºÐ°',
			'36'=>'ÐšÐ¸Ð½Ð¾ - ÐšÐ¾Ð½Ñ†ÐµÑ€Ñ‚ / Ð¢Ð’-ÑˆÐ¾Ñƒ',
			'38'=>'ÐšÐ¸Ð½Ð¾ - Ð¢ÐµÐ°Ñ‚Ñ€, ÐžÐ¿ÐµÑ€Ð°, Ð‘Ð°Ð»ÐµÑ‚',
			'16'=>'ÐšÐ¸Ð½Ð¾ - Ð­Ñ€Ð¾Ñ‚Ð¸ÐºÐ°',
			'21'=>'ÐœÑƒÐ»ÑŒÑ‚ - Ð‘ÑƒÑ€Ð¶ÑƒÐ¹ÑÐºÐ¸Ð¹',
			'22'=>'ÐœÑƒÐ»ÑŒÑ‚ - Ð ÑƒÑÑÐºÐ¸Ð¹',
			'20'=>'ÐœÑƒÐ»ÑŒÑ‚ - ÐÐ½Ð¸Ð¼Ðµ',
			'3'=>'ÐœÑƒÐ·Ñ‹ÐºÐ° - Ð‘ÑƒÑ€Ð¶ÑƒÐ¹ÑÐºÐ°Ñ',
			'4'=>'ÐœÑƒÐ·Ñ‹ÐºÐ° - Ð ÑƒÑÑÐºÐ°Ñ',
			'42'=>'ÐœÑƒÐ·Ñ‹ÐºÐ° - ÐšÐ»Ð°ÑÑÐ¸Ñ‡ÐµÑÐºÐ°Ñ',
			'2'=>'Ð”Ñ€ÑƒÐ³Ð¾Ðµ - ÐÑƒÐ´Ð¸Ð¾ÐšÐ½Ð¸Ð³Ð¸',
			'1'=>'Ð”Ñ€ÑƒÐ³Ð¾Ðµ - Ð’Ð¸Ð´ÐµÐ¾ÐºÐ»Ð¸Ð¿Ñ‹',
			'23'=>'Ð”Ñ€ÑƒÐ³Ð¾Ðµ - Ð˜Ð³Ñ€Ñ‹',
			'32'=>'Ð”Ñ€ÑƒÐ³Ð¾Ðµ - ÐŸÑ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼Ñ‹',
			'40'=>'Ð”Ñ€ÑƒÐ³Ð¾Ðµ - Ð“Ñ€Ð°Ñ„Ð¸ÐºÐ°',
			'41'=>'Ð”Ñ€ÑƒÐ³Ð¾Ðµ - Ð‘Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ°' );
		return(array_key_exists($cat,$categories) ? $categories[$cat] : '');
	}

	protected static function formatTime($time)
	{
		$search = array( ' ÿíâàðÿ ', ' ôåâðàëÿ ', ' ìàðòà ', ' àïðåëÿ ', ' ìàÿ ', ' èþíÿ ', 
			' èþëÿ ', ' àâãóñòà ', ' ñåíòÿáðÿ ', ' îêòÿáðÿ ', ' íîÿáðÿ ', ' äåêàáðÿ ', 'â÷åðà ', ' ñåãîäíÿ ' );
		$replace = array( '.01.', '.02.', '.03.', '.04.', '.05.', '.06.', 
			'.07.', '.08.', '.09.', '.10.', '.11.', '.12.', '-1 day ', '0 day ' );
		return( strtotime(str_replace( $search, $replace, $time )) );
	}

	public function action($what,$cat,&$ret,$limit,$useGlobalCats)
	{
		$added = 0;
		$url = 'https://kinozal.guru';
		if($useGlobalCats)
			$categories = array( 'all'=>'0', 'tv'=>'5', 'games'=>'23', 'anime'=>'20', 'software'=>'32', 'pictures'=>'40', 'books'=>'41' );
		else
			$categories = &$this->categories;
		if(!array_key_exists($cat,$categories))
			$cat = $categories['all'];
		else
			$cat = $categories[$cat];
		$what = rawurlencode(self::fromUTF(rawurldecode($what),"CP1251"));
		for($pg = 0; $pg<11; $pg++)
		{
			$cli = $this->fetch( $url.'/browse.php?s='.$what.'&a=3&page='.$pg.'&c='.$cat );
			if( ($cli==false) || 
				(strpos($cli->results, "<br><center><b>Íåò àêòèâíûõ ðàçäà÷")!==false) ||
				(strpos($cli->results, '<input type=password size=48 name="password"')!==false)
				)
				break;

			$res = preg_match_all('|<tr class=bg><td class="bt"><img src=.* onclick="cat(?P<cat>.*);".*'.
				'<a href="/details.php\?.*id=(?P<id>\d+)".*>(?P<name>.*)</a>.*'.
				'<td class=.*>\d+</td>.*'.
				'<td class=.*>(?P<size>.*)</td>.*'.
				'<td class=.*>(?P<leech>.*)</td>.*'.
				'<td class=.*>(?P<seeds>.*)</td>.*'.
				'<td class=.*>(?P<date>.*)</td>|siU', $cli->results, $matches);
			if($res)
			{
				for($i=0; $i<$res; $i++)
				{
					$link = $url."/download.php?id=".$matches["id"][$i];
					if(!array_key_exists($link,$ret))
					{
						$item = $this->getNewEntry();
						$item["cat"] = self::getInnerCategory($matches["cat"][$i]);
						$item["desc"] = $url."/details.php?id=".$matches["id"][$i];
						$item["name"] = self::toUTF(self::removeTags($matches["name"][$i],"CP1251"),"CP1251");
						$item["size"] = self::formatSize(str_replace("<br>"," ",$matches["size"][$i]));
						$item["seeds"] = intval(self::removeTags($matches["seeds"][$i]));
						$item["peers"] = intval(self::removeTags($matches["leech"][$i]));
						$item["time"] = self::formatTime(self::removeTags(str_replace("â ", "",$matches["date"][$i])));
						$ret[$link] = $item;
						$added++;
						if($added>=$limit)
							return;
					}
				}
			}
			else
				break;
		}
	}
}
